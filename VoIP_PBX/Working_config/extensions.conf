; Extension format -> exten => number,priority,application([parameter[,parameter2...]])
; Priority should monotonically increase by 1 with every command
; You can use n as the priority to implicitly increment it by 1
; Check https://wiki.asterisk.org/wiki/display/AST/Contexts%2C+Extensions%2C+and+Priorities for more info!

[globals]
Q_50=foo
Q_51=fuu
; Include users here and condense every calling rule!

; Define hints to be able to query the agent's state!
; The hint's context is configured in sip.conf
[queue-agents]
exten => foo_agent,hint,SIP/foo_agent
exten => fuu_agent,hint,SIP/fuu_agent


; Take a look at https://wiki.asterisk.org/wiki/display/AST/Building+Queues
; for automatic login. I don't think it's really worth the effort though
[agents]
exten => 555,1,Playback(tt-monkeys)
	same => n,Hangup()

[secure-context]
exten => 100,1,Answer()
	same => n,Wait(1)
	same => n,Playback(tt-weasels)
	same => n,Wait(1)
	same => n,Hangup()

[from-internal]
exten => _5X,1,Verbose(2, Going to a queue, hopefully)
	same => n,Set(req_queue=${GLOBAL(Q_${EXTEN})})
	same => n,GotoIf($["$req_queue" = ""]?wrong_queue,1)
	same => n,Verbose(2,Going into Queue ${req_queue})
	same => n,Queue(${req_queue})
	same => n,Hangup()

exten => wrong_queue,1,Playback(tt-weasels)
	same => n,Wait(1)
	same => n,Hangup()

exten => 50,1,Queue(foo)

exten => 51,1,Queue(fuu)

exten => 100,1,Answer()
     same => n,Wait(1)
     same => n,Verbose(2,Read values: ${ODBC_SQL(SELECT * FROM call_data WHERE call_number = 1)})
     same => n,Verbose(${ODBC_SQL(INSERT INTO call_data (caller_id, called_exten) VALUES (\"${CALLERID(all):4:-1}\", ${EXTEN}))})
     same => n,Playback(hello-world)
     ; same => n,Playback(/home/vagrant/estefania)
     ;same => n,Hangup()

; Take a look @ http://asteriskdocs.org/en/3rd_Edition/asterisk-book-html-chunk/ExternalServices_id291618.html for more info and setup!
exten => 203,1,Verbose(2,This is a Festival test)
   same => n,Answer()
   same => n,Playback(silence/1)
   same => n,Festival(Hello there!)
   ;same => n,Hangup()

exten => 202,1,Verbose(2,Trying out Festival)
   same => 2,Answer()
   same => 3,System(echo "Hello there" | /usr/bin/text2wave -scale 1.5 -F 8000 -o /tmp/festival.wav)
   same => 4,Playback(/tmp/festival)
   same => 5,System(rm -f /tmp/festival.wav)
   ;same => n,Hangup()
   same => n,gosub(store-data-end,s,1,(${EXTEN}))

exten => 204,1,Verbose(2, Get the RFC)
     same => n,Answer()
     same => n,System(echo "Please say the desired RFC number" | /usr/bin/text2wave -scale 1.5 -F 8000 -o /tmp/prompt.wav)
     same => n,Playback(/tmp/prompt)
     same => n,System(rm -f /tmp/prompt.wav)
     same => n,Record(/tmp/recording.wav)
     same => n,AGI(time_to_rfc.py,/tmp/recording.wav)
     same => n,Playback(/tmp/title)
     same => n,System(rm -f /tmp/recording.wav)
	 same => n,System(rm -f /tmp/title.wav)
     same => n,Hangup()

; Take a look at https://wiki.asterisk.org/wiki/display/AST/Configuring+Voice+Mail+Boxes
exten => 400,1,VoiceMailMain()
	same => n,Hangup()
	;same => n,Playback(spy-agent)
	;same => n,Hangup()

; User calls!
exten => 200,1,gosub(store-data,s,1,(${EXTEN}))
	same => n,Dial(SIP/pablo,10,tm(default))
	same => n,VoiceMail(200)

exten => 300,1,gosub(store-data,s,1,(${EXTEN}))
	same => n,Dial(SIP/alice,10,tm(default))
	same => n,VoiceMail(300)

exten => 600,1,Dial(SIP/foo,10,tm(default))
	same => n,VoiceMail(600)

exten => 601,1,Dial(SIP/foodb,10,tm(native-random))
	same => n,VoiceMail(601)

; Group Calls
exten => 500,1,Answer()
	same => n,ConfBridge(1234)

; Call Center Menu
exten => 700,1,Goto(call-center-menu,s,1)

; Testing AGI Apps
exten => 800,1,Answer()
	same => n,AGI(agi_test.py)

; Call center menu macro. Macros start with an s extension! Info @ (https://wiki.asterisk.org/wiki/display/AST/Macros)
[call-center-menu]
exten => s,1,Answer()
	same => n(main),Background(press-1&or&press-2)
	same => n,WaitExten()

exten => 1,1,Playback(you-entered)
	same => n,SayNumber(1)
	same => n(maina),Background(press-3&or&press-4&or&vm-helpexit)
	same => n,WaitExten()

exten => 2,1,Playback(you-entered)
	same => n,SayNumber(2)
	same => n,Playback(vm-goodbye)
	same => n,Wait(1)
	same => n,Hangup() 

exten => 3,1,Playback(spy-agent)
	same => n,goto(s,main)

exten => 4,1,Playback(hello-world)
	same => n,Dial(SIP/pablo)

exten => #,1,Playback(vm-goodbye)
	same => n,Hangup()

[store-data]
exten => s,1,Verbose(${ODBC_SQL(INSERT INTO call_data (caller_id, called_exten) VALUES (\"${CALLERID(all):4:-1}\", ${ARG1}))})
    same => n,Return()

[store-data-end]
exten => s,1,Verbose(${ODBC_SQL(INSERT INTO call_data (caller_id, called_exten) VALUES (\"${CALLERID(all):4:-1}\", ${ARG1}))})
    same => n,Hangup()
